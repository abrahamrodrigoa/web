<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inspecci√≥n Diaria de Obra ‚Äî RDO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --bg: #0b0f13;
        --panel: #121820;
        --muted: #1a2330;
        --text: #e6edf3;
        --sub: #b7c3cf;
        --brand: #43b581;
        --brand2: #4aa8ff;
        --danger: #f25f5c;
        --warn: #f2a365;
        --ok: #4fd1c5;
      }
      * {
        box-sizing: border-box;
      }
      body {
        background: linear-gradient(180deg, #0b0f13, #0b0f13 40%, #0f1520);
        color: var(--text);
      }
      .section-card {
        transition: all 0.25s ease;
        background: linear-gradient(180deg, #0e141b, #0b1118);
      }
      .section-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.35);
      }
      label {
        color: var(--sub);
      }
      input,
      select,
      textarea {
        background: #0a1218;
        border: 1px solid #223044;
        color: var(--text);
        border-radius: 12px;
        outline: none;
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: #376da2;
        box-shadow: 0 0 0 3px rgba(74, 168, 255, 0.15);
      }
      .photo-preview {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid #233042;
      }
      .btn {
        border-radius: 12px;
        font-weight: 700;
      }
      .btn-primary {
        background: linear-gradient(180deg, #1c8b64, #116a4d);
        color: #fff;
        border: 1px solid #1ea372;
      }
      .btn-secondary {
        background: linear-gradient(180deg, #1a2740, #121a2c);
        color: #dde6f0;
        border: 1px solid #2a3c5a;
      }
      .btn-ghost {
        background: transparent;
        border: 1px dashed #2a3c5a;
        color: #a9bad0;
      }
      .hint {
        font-size: 0.85rem;
        color: #9db2c7;
      }
      /* Print */
      @media print {
        body {
          background: #fff;
          color: #000;
        }
        .no-print {
          display: none !important;
        }
        input,
        select,
        textarea {
          border: 1px solid #999;
        }
        .section-card {
          box-shadow: none;
        }
        video {
          display: none;
        }
      }
    </style>
  </head>
  <body class="min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
      <!-- Header -->
      <div class="section-card rounded-xl border border-slate-800 p-6 mb-6">
        <div class="flex items-center gap-4">
          <div class="bg-blue-600/90 p-4 rounded-xl">
            <svg
              class="w-8 h-8 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
          </div>
          <div>
            <h1 class="text-3xl font-bold">Inspecci√≥n Diaria de Obra ‚Äî RDO</h1>
            <p class="text-slate-300">
              Complete todos los campos para generar el reporte autom√°tico
            </p>
          </div>
        </div>
      </div>

      <form id="inspectionForm" class="space-y-6">
        <!-- 1. INFORMACI√ìN GENERAL -->
        <div class="section-card rounded-xl border border-slate-800 p-6">
          <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            <span
              class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm"
              >1</span
            >
            Informaci√≥n General
          </h2>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-2">Proyecto</label>
              <input
                type="text"
                name="proyecto"
                required
                class="w-full px-4 py-2"
                placeholder="Nombre del proyecto"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2"
                >Contrato No.</label
              >
              <input
                type="text"
                name="contrato"
                required
                class="w-full px-4 py-2"
                placeholder="CT-2024-XXX"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2">Ubicaci√≥n</label>
              <input
                type="text"
                name="ubicacion"
                required
                class="w-full px-4 py-2"
                placeholder="Direcci√≥n de la obra"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2">Fecha</label>
              <input
                type="date"
                name="fecha"
                required
                class="w-full px-4 py-2"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2"
                >Inspector Responsable</label
              >
              <input
                type="text"
                name="inspector"
                required
                class="w-full px-4 py-2"
                placeholder="Ing. Nombre Apellido"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2">Turno</label>
              <select name="turno" required class="w-full px-4 py-2">
                <option value="">Seleccionar...</option>
                <option value="Matutino (07:00-15:00)">
                  Matutino (07:00-15:00)
                </option>
                <option value="Vespertino (15:00-23:00)">
                  Vespertino (15:00-23:00)
                </option>
                <option value="Completo (07:00-18:00)">
                  Completo (07:00-18:00)
                </option>
              </select>
            </div>
          </div>
        </div>

        <!-- 2. CONDICIONES CLIM√ÅTICAS -->
        <div class="section-card rounded-xl border border-slate-800 p-6">
          <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            <span
              class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm"
              >2</span
            >
            Condiciones Clim√°ticas
          </h2>
          <div class="grid md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-2"
                >Temperatura (¬∞C)</label
              >
              <input
                type="text"
                name="temperatura"
                required
                class="w-full px-4 py-2"
                placeholder="18 - 24"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2">Condici√≥n</label>
              <select name="clima" required class="w-full px-4 py-2">
                <option value="">Seleccionar...</option>
                <option value="Despejado">‚òÄÔ∏è Despejado</option>
                <option value="Parcialmente nublado">
                  ‚õÖ Parcialmente nublado
                </option>
                <option value="Nublado">‚òÅÔ∏è Nublado</option>
                <option value="Lluvia">üåßÔ∏è Lluvia</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2">Trabajable</label>
              <select name="trabajable" required class="w-full px-4 py-2">
                <option value="S√ç">‚úÖ S√ç</option>
                <option value="NO">‚ùå NO</option>
                <option value="PARCIAL">‚ö†Ô∏è PARCIAL</option>
              </select>
            </div>
          </div>
        </div>

        <!-- 3.1 MANO DE OBRA -->
        <div class="section-card rounded-xl border border-slate-800 p-6">
          <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            <span
              class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm"
              >3</span
            >
            Mano de Obra
          </h2>
          <div class="grid md:grid-cols-3 gap-4 mb-2">
            <div>
              <label class="block text-sm font-semibold mb-2"
                >Personal Planificado</label
              >
              <input
                type="number"
                name="personal_planificado"
                required
                class="w-full px-4 py-2"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2"
                >Personal Presente</label
              >
              <input
                type="number"
                name="personal_presente"
                required
                class="w-full px-4 py-2"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2"
                >Personal Ausente</label
              >
              <input
                type="number"
                name="personal_ausente"
                required
                class="w-full px-4 py-2"
              />
            </div>
          </div>
        </div>

        <!-- 3.1 EQUIPOS -->
        <div class="section-card rounded-xl border border-slate-800 p-6">
          <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            <span
              class="bg-cyan-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm"
              >4</span
            >
            Equipos
          </h2>
          <div id="equiposContainer" class="space-y-4"></div>
          <button
            type="button"
            onclick="addEquipo()"
            class="mt-4 btn btn-secondary px-4 py-2"
          >
            + Agregar Equipo
          </button>
          <p class="text-sm text-slate-400 mt-2">
            Registra cada equipo con su operador, horas de uso y estado
            operacional.
          </p>
        </div>

        <!-- 3.2 MATERIALES -->
        <div class="section-card rounded-xl border border-slate-800 p-6">
          <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            <span
              class="bg-emerald-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm"
              >5</span
            >

            Materiales
          </h2>
          <div id="materialesContainer" class="space-y-4"></div>
          <button
            type="button"
            onclick="addMaterial()"
            class="mt-4 btn btn-secondary px-4 py-2"
          >
            + Agregar Material
          </button>
          <p class="text-sm text-slate-400 mt-2">
            Registra ingresos, consumos y salidas; la unidad ayuda al control.
          </p>
        </div>

        <!-- 3.3 CONTROL DE CALIDAD -->
        <div class="section-card rounded-xl border border-slate-800 p-6">
          <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            <span
              class="bg-fuchsia-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm"
              >6</span
            >

            Control de Calidad
          </h2>
          <div id="calidadContainer" class="space-y-4"></div>
          <button
            type="button"
            onclick="addCalidad()"
            class="mt-4 btn btn-secondary px-4 py-2"
          >
            + Agregar Control
          </button>
          <p class="text-sm text-slate-400 mt-2">
            Registra ensayos/verificaciones (norma, resultado y conformidad).
          </p>
        </div>

        <!-- 4. ACTIVIDADES (Din√°mico) -->
        <div class="section-card rounded-xl border border-slate-800 p-6">
          <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            <span
              class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm"
              >7</span
            >

            Actividades por Zona
          </h2>
          <div id="activityContainer" class="space-y-4"></div>
          <button
            type="button"
            onclick="addActivity()"
            class="mt-4 btn btn-primary px-4 py-2"
          >
            + Agregar Actividad
          </button>
        </div>

        <!-- 5. INCIDENTES (Din√°mico) -->
        <div class="section-card rounded-xl border border-slate-800 p-6">
          <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            <span
              class="bg-orange-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm"
              >8</span
            >
            Incidentes y No Conformidades
          </h2>
          <div id="incidentContainer" class="space-y-4"></div>
          <button
            type="button"
            onclick="addIncident()"
            class="mt-4 btn btn-secondary px-4 py-2"
          >
            + Reportar Incidente
          </button>
        </div>

        <!-- 6. REGISTRO FOTOGR√ÅFICO (Upload + C√°mara, m√°x 5) -->
        <div class="section-card rounded-xl border border-slate-800 p-6">
          <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            <span
              class="bg-purple-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm"
              >9</span
            >
            Registro Fotogr√°fico
          </h2>

          <!-- Subir -->
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2"
              >Subir Fotos (m√°x 5)</label
            >
            <input
              type="file"
              id="fotosInput"
              accept="image/*"
              multiple
              class="w-full px-4 py-2"
            />
            <p class="hint mt-1">
              Puedes combinar fotos subidas y capturas de c√°mara. M√°ximo 5 en
              total.
            </p>
          </div>

          <!-- C√°mara -->
          <div class="mb-3 flex flex-wrap gap-3">
            <button
              type="button"
              id="btnStartCam"
              class="btn btn-secondary px-4 py-2 no-print"
            >
              Activar c√°mara
            </button>
            <button
              type="button"
              id="btnCapture"
              class="btn btn-ghost px-4 py-2 no-print"
              disabled
            >
              Tomar foto
            </button>
            <button
              type="button"
              id="btnStopCam"
              class="btn btn-ghost px-4 py-2 no-print"
              disabled
            >
              Detener
            </button>
          </div>
          <div class="grid md:grid-cols-2 gap-4 no-print">
            <video
              id="video"
              playsinline
              autoplay
              class="w-full rounded-lg border border-slate-700 hidden"
            ></video>
            <canvas id="canvas" class="hidden"></canvas>
          </div>

          <!-- Previsualizaci√≥n -->
          <div
            id="photoPreview"
            class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-4"
          ></div>
        </div>

        <!-- BOTONES DE ACCI√ìN -->
        <div class="section-card rounded-xl border border-slate-800 p-6">
          <div class="flex flex-col md:flex-row gap-3 md:items-center">
            <button type="submit" class="btn btn-primary px-6 py-3 text-lg">
              üöÄ Generar Reporte (Webhook)
            </button>
            <button
              type="button"
              id="btnIA"
              class="btn btn-secondary px-6 py-3 text-lg"
            >
              ü§ñ An√°lisis por IA
            </button>
            <button
              type="button"
              onclick="window.print()"
              class="btn btn-ghost px-6 py-3 text-lg"
            >
              üñ®Ô∏è Imprimir PDF
            </button>
            <p class="text-sm text-slate-300">
              El sistema generar√°/analizar√° el JSON y podr√°s imprimir el
              reporte.
            </p>
          </div>
        </div>
      </form>

      <!-- Loading Modal -->
      <div
        id="loadingModal"
        class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50"
      >
        <div
          class="bg-white/95 text-slate-900 rounded-xl p-8 text-center max-w-sm shadow-2xl"
        >
          <div
            class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"
          ></div>
          <p class="text-xl font-bold">Procesando...</p>
          <p class="text-slate-600">La IA est√° trabajando con tus datos</p>
        </div>
      </div>
    </div>

    <script>
      // ========= Configuraci√≥n de Webhooks =========
      const WEBHOOK_URL =
        "https://uncontracted-pettedly-gannon.ngrok-free.app/webhook-test/inspeccion-diaria";
      const ANALYSIS_WEBHOOK_URL =
        "https://uncontracted-pettedly-gannon.ngrok-free.app/webhook-test/inspeccion-diaria-analisis";

      // ========= Estado global para fotos =========
      const MAX_FOTOS = 5;
      let capturedImages = []; // base64 desde c√°mara
      let uploadedImages = []; // base64 desde input
      let mediaStream = null;

      // ========= Din√°micos: Actividades / Incidentes =========
      let activityCount = 0;
      let incidentCount = 0;

      function addActivity() {
        activityCount++;
        const container = document.getElementById("activityContainer");
        const div = document.createElement("div");
        div.className =
          "border border-blue-900/50 rounded-xl p-4 bg-blue-950/20";
        div.innerHTML = `
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold">Actividad #${activityCount}</h3>
      <button type="button" onclick="this.closest('div.border').remove()" class="text-red-400 hover:text-red-300">‚ùå</button>
    </div>
    <div class="grid md:grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-semibold mb-1">Zona</label>
        <input type="text" name="actividad_zona[]" required class="w-full px-3 py-2" placeholder="Ej: Nivel 4 - Estructura">
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Actividad</label>
        <input type="text" name="actividad_nombre[]" required class="w-full px-3 py-2" placeholder="Ej: Vaciado de losa">
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">% Avance Real</label>
        <input type="number" name="actividad_avance[]" required min="0" max="100" class="w-full px-3 py-2">
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">% Programado</label>
        <input type="number" name="actividad_programado[]" required min="0" max="100" class="w-full px-3 py-2">
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-semibold mb-1">Observaciones</label>
        <textarea name="actividad_obs[]" required class="w-full px-3 py-2" rows="2"></textarea>
      </div>
    </div>
  `;
        container.appendChild(div);
      }

      function addIncident() {
        incidentCount++;
        const container = document.getElementById("incidentContainer");
        const div = document.createElement("div");
        div.className =
          "border border-orange-900/50 rounded-xl p-4 bg-orange-900/20";
        div.innerHTML = `
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold">Incidente #${incidentCount}</h3>
      <button type="button" onclick="this.closest('div.border').remove()" class="text-red-400 hover:text-red-300">‚ùå</button>
    </div>
    <div class="grid md:grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-semibold mb-1">Tipo</label>
        <select name="incidente_tipo[]" required class="w-full px-3 py-2">
          <option value="">Seleccionar...</option>
          <option value="Seguridad">Seguridad</option>
          <option value="Calidad">Calidad</option>
          <option value="Ambiental">Ambiental</option>
          <option value="Operacional">Operacional</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Severidad</label>
        <select name="incidente_severidad[]" required class="w-full px-3 py-2">
          <option value="">Seleccionar...</option>
          <option value="baja">üü¢ Baja</option>
          <option value="media">üü° Media</option>
          <option value="alta">üî¥ Alta</option>
        </select>
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-semibold mb-1">Descripci√≥n</label>
        <textarea name="incidente_desc[]" required class="w-full px-3 py-2" rows="2"></textarea>
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-semibold mb-1">Acci√≥n Tomada</label>
        <textarea name="incidente_accion[]" required class="w-full px-3 py-2" rows="2"></textarea>
      </div>
    </div>
  `;
        container.appendChild(div);
      }

      // ======== Din√°micos: Equipos / Materiales / Calidad ========
      let equipoCount = 0;
      let materialCount = 0;
      let calidadCount = 0;

      function addEquipo() {
        equipoCount++;
        const cont = document.getElementById("equiposContainer");
        const div = document.createElement("div");
        div.className =
          "border border-cyan-900/50 rounded-xl p-4 bg-cyan-900/15";
        div.innerHTML = `
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold">Equipo #${equipoCount}</h3>
      <button type="button" onclick="this.closest('div.border').remove()" class="text-red-400 hover:text-red-300">‚ùå</button>
    </div>
    <div class="grid md:grid-cols-3 gap-3">
      <div>
        <label class="block text-sm font-semibold mb-1">Tipo/Equipo</label>
        <input type="text" name="equipo_tipo[]" required class="w-full px-3 py-2" placeholder="Retroexcavadora, Mixer, Gr√∫a">
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">C√≥digo/Placa</label>
        <input type="text" name="equipo_codigo[]" required class="w-full px-3 py-2" placeholder="EQ-045 / ABC-123">
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Operador</label>
        <input type="text" name="equipo_operador[]" required class="w-full px-3 py-2" placeholder="Nombre del operador">
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Horas Uso (h)</label>
        <input type="number" min="0" step="0.1" name="equipo_horas[]" required class="w-full px-3 py-2" placeholder="0.0">
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Estado</label>
        <select name="equipo_estado[]" required class="w-full px-3 py-2">
          <option value="">Seleccionar...</option>
          <option value="Operativo">Operativo</option>
          <option value="Mantenimiento">Mantenimiento</option>
          <option value="Fuera de servicio">Fuera de servicio</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Observaciones</label>
        <input type="text" name="equipo_obs[]" class="w-full px-3 py-2" placeholder="Opcional">
      </div>
    </div>
  `;
        cont.appendChild(div);
      }

      function addMaterial() {
        materialCount++;
        const cont = document.getElementById("materialesContainer");
        const div = document.createElement("div");
        div.className =
          "border border-emerald-900/50 rounded-xl p-4 bg-emerald-900/15";
        div.innerHTML = `
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold">Material #${materialCount}</h3>
      <button type="button" onclick="this.closest('div.border').remove()" class="text-red-400 hover:text-red-300">‚ùå</button>
    </div>
    <div class="grid md:grid-cols-3 gap-3">
      <div>
        <label class="block text-sm font-semibold mb-1">Material</label>
        <input type="text" name="mat_nombre[]" required class="w-full px-3 py-2" placeholder="Cemento, Acero, Arena">
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Unidad</label>
        <input type="text" name="mat_unidad[]" required class="w-full px-3 py-2" placeholder="kg, m¬≥, und">
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Ingreso</label>
        <input type="number" min="0" step="0.01" name="mat_ingreso[]" required class="w-full px-3 py-2" placeholder="0.00">
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Consumo</label>
        <input type="number" min="0" step="0.01" name="mat_consumo[]" required class="w-full px-3 py-2" placeholder="0.00">
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Salida</label>
        <input type="number" min="0" step="0.01" name="mat_salida[]" required class="w-full px-3 py-2" placeholder="0.00">
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Proveedor/Lote</label>
        <input type="text" name="mat_proveedor[]" class="w-full px-3 py-2" placeholder="Opcional">
      </div>
      <div class="md:col-span-3">
        <label class="block text-sm font-semibold mb-1">Observaciones</label>
        <textarea name="mat_obs[]" class="w-full px-3 py-2" rows="2" placeholder="Condiciones de almacenamiento, humedad, etc."></textarea>
      </div>
    </div>
  `;
        cont.appendChild(div);
      }

      function addCalidad() {
        calidadCount++;
        const cont = document.getElementById("calidadContainer");
        const div = document.createElement("div");
        div.className =
          "border border-fuchsia-900/50 rounded-xl p-4 bg-fuchsia-900/15";
        div.innerHTML = `
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold">Control #${calidadCount}</h3>
      <button type="button" onclick="this.closest('div.border').remove()" class="text-red-400 hover:text-red-300">‚ùå</button>
    </div>
    <div class="grid md:grid-cols-3 gap-3">
      <div>
        <label class="block text-sm font-semibold mb-1">√çtem / Partida</label>
        <input type="text" name="cal_item[]" required class="w-full px-3 py-2" placeholder="Ej: Concreto f'c 280, Soldadura...">
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Norma/Procedimiento</label>
        <input type="text" name="cal_norma[]" required class="w-full px-3 py-2" placeholder="NTP/ASTM/EN, IT-XX">
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Ensayo/Verificaci√≥n</label>
        <input type="text" name="cal_ensayo[]" required class="w-full px-3 py-2" placeholder="Asentamiento, Esclerometr√≠a, VT/RT...">
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Resultado</label>
        <input type="text" name="cal_resultado[]" required class="w-full px-3 py-2" placeholder="Valor num√©rico o texto">
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Conforme</label>
        <select name="cal_conforme[]" required class="w-full px-3 py-2">
          <option value="">Seleccionar...</option>
          <option value="SI">SI</option>
          <option value="NO">NO</option>
          <option value="CONDICIONAL">CONDICIONAL</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Observaciones</label>
        <input type="text" name="cal_obs[]" class="w-full px-3 py-2" placeholder="Acciones, NCR, seguimiento">
      </div>
    </div>
  `;
        cont.appendChild(div);
      }

      // ========= Fotos: subir + c√°mara =========
      const fotosInput = document.getElementById("fotosInput");
      const photoPreview = document.getElementById("photoPreview");
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const btnStartCam = document.getElementById("btnStartCam");
      const btnCapture = document.getElementById("btnCapture");
      const btnStopCam = document.getElementById("btnStopCam");

      // ===== Forzar c√°mara trasera en Edge/Chrome por deviceId =====
      let isCapturing = false; // anti-doble captura
      let rearDeviceId = null; // se resolver√° tras el primer permiso

      function delay(ms) {
        return new Promise((r) => setTimeout(r, ms));
      }

      async function pickRearCameraDeviceId() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videos = devices.filter((d) => d.kind === "videoinput");

        // Heur√≠stica: buscar "back", "rear", "environment"
        const re = /(back|rear|environment)/i;
        let rear = videos.find((v) => re.test(v.label));

        // Si no hay etiqueta ‚Äúrear/back‚Äù, Edge suele listar frontal primero y trasera despu√©s ‚Üí usa la √∫ltima.
        if (!rear && videos.length > 1) rear = videos[videos.length - 1];

        // Fallback: la √∫nica c√°mara disponible
        if (!rear && videos.length >= 1) rear = videos[0];

        return rear ? rear.deviceId : null;
      }

      async function ensureCamera() {
        if (!isSecureContext) {
          alert("‚ö†Ô∏è Necesitas HTTPS o http://localhost para usar la c√°mara.");
          return false;
        }
        // Ya activa
        if (mediaStream && !video.classList.contains("hidden")) return true;

        try {
          // 1) Si a√∫n no tenemos deviceId trasero, primero pedimos permiso gen√©rico (desbloquea labels en Edge)
          if (!rearDeviceId) {
            const tmp = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: false,
            });
            tmp.getTracks().forEach((t) => t.stop()); // cerramos stream temporal
            await delay(100); // peque√±a espera para que aparezcan labels
            rearDeviceId = await pickRearCameraDeviceId();
          }

          // 2) Si a√∫n as√≠ no se detecta, volvemos a intentar enumerar
          if (!rearDeviceId) rearDeviceId = await pickRearCameraDeviceId();

          // 3) Abrimos espec√≠ficamente la c√°mara trasera por deviceId (o la disponible)
          const constraints = rearDeviceId
            ? { audio: false, video: { deviceId: { exact: rearDeviceId } } }
            : { audio: false, video: true };

          mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
          video.srcObject = mediaStream;
          video.classList.remove("hidden");
          btnCapture.disabled = false;
          btnStopCam.disabled = false;

          await video.play();
          await delay(150); // asegura videoWidth/Height listos
          return true;
        } catch (err) {
          const name = err?.name || "";
          const msg = err?.message || "";
          let why = "Error al abrir la c√°mara.";
          if (name === "NotAllowedError" || name === "SecurityError") {
            why =
              "Permiso denegado. Revisa permisos en el navegador (candado) y en el sistema.";
          } else if (
            name === "NotReadableError" ||
            name === "TrackStartError"
          ) {
            why =
              "La c√°mara est√° en uso por otra app. Cierra otras aplicaciones que la usen.";
          } else if (name === "NotFoundError") {
            why = "No se encontr√≥ c√°mara disponible.";
          }
          alert(`${why}\n(${name}: ${msg})`);
          console.error(err);
          return false;
        }
      }

      // --- ADICI√ìN: control y encendido de c√°mara trasera ---
      let isCapturing = false; // evita doble disparo

      async function ensureCamera() {
        // HTTPS o localhost
        if (!isSecureContext) {
          alert("‚ö†Ô∏è Necesitas HTTPS o http://localhost para usar la c√°mara.");
          return false;
        }
        // si ya est√° activa y visible
        if (mediaStream && !video.classList.contains("hidden")) return true;

        // intentar trasera con fallbacks (environment exact -> environment -> default)
        async function getRearStream() {
          try {
            return await navigator.mediaDevices.getUserMedia({
              audio: false,
              video: { facingMode: { exact: "environment" } },
            });
          } catch (_) {
            try {
              return await navigator.mediaDevices.getUserMedia({
                audio: false,
                video: { facingMode: "environment" },
              });
            } catch (_) {
              return await navigator.mediaDevices.getUserMedia({
                audio: false,
                video: true,
              });
            }
          }
        }

        try {
          mediaStream = await getRearStream();
          video.srcObject = mediaStream;
          video.classList.remove("hidden");
          btnCapture.disabled = false;
          btnStopCam.disabled = false;
          await video.play();
          // esperar un momento para que videoWidth/Height est√©n listos
          await new Promise((r) => setTimeout(r, 200));
          return true;
        } catch (err) {
          const name = err?.name || "";
          const msg = err?.message || "";
          let why = "Error al abrir la c√°mara.";
          if (name === "NotAllowedError" || name === "SecurityError") {
            why =
              "Permiso denegado. Revisa permisos en el navegador (candado) y en el sistema.";
          } else if (
            name === "NotReadableError" ||
            name === "TrackStartError"
          ) {
            why =
              "La c√°mara est√° en uso por otra aplicaci√≥n. Ci√©rrala e int√©ntalo otra vez.";
          } else if (name === "NotFoundError") {
            why = "No se encontr√≥ c√°mara disponible.";
          }
          alert(`${why}\n(${name}: ${msg})`);
          console.error(err);
          return false;
        }
      }

      function explainGetUserMediaError(err) {
        const name = err && err.name ? err.name : "";
        const msg = err && err.message ? err.message : "";
        if (!isSecureContext) {
          return "Esta p√°gina no est√° en un contexto seguro. Usa HTTPS o http://localhost.";
        }
        switch (name) {
          case "NotAllowedError":
          case "SecurityError":
            return "Permiso denegado. Revisa permisos del navegador (candado en la URL) y del sistema operativo para la c√°mara.";
          case "NotFoundError":
            return "No se encontr√≥ c√°mara. Verifica que haya dispositivo disponible.";
          case "NotReadableError":
          case "TrackStartError":
            return "La c√°mara est√° siendo usada por otra aplicaci√≥n o no puede abrirse. Cierra otras apps que usen la c√°mara.";
          case "OverconstrainedError":
            return "Restricciones no compatibles con el dispositivo. Prueba sin constraints personalizados.";
          default:
            return `Error al abrir la c√°mara: ${
              name || "Desconocido"
            } ‚Äî ${msg}`;
        }
      }

      async function ensureCamera() {
        // 1) Secure context
        if (!isSecureContext) {
          alert("‚ö†Ô∏è Necesitas HTTPS o http://localhost para usar la c√°mara.");
          return false;
        }
        // 2) Si ya est√° activa
        if (mediaStream && !video.classList.contains("hidden")) return true;

        try {
          // No pongas constraints avanzados; deja que el navegador elija
          mediaStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: false,
          });
          video.srcObject = mediaStream;
          video.classList.remove("hidden");
          btnCapture.disabled = false;
          btnStopCam.disabled = false;

          // Peque√±o delay para que videoWidth/Height est√©n listos
          await new Promise((r) => setTimeout(r, 200));
          return true;
        } catch (err) {
          alert(explainGetUserMediaError(err));
          console.error(err);
          return false;
        }
      }

      // Activar c√°mara (intentar√° trasera por deviceId)
      btnStartCam.addEventListener("click", async () => {
        await ensureCamera();
      });

      // Tomar foto: auto-enciende + anti-doble-foto
      btnCapture.addEventListener("click", async () => {
        const ready = await ensureCamera();
        if (!ready) return;

        if (isCapturing) return; // evita 2 fotos
        isCapturing = true;

        try {
          if (totalFotos() >= MAX_FOTOS) {
            alert(`M√°ximo ${MAX_FOTOS} fotos en total.`);
            return;
          }
          const w = video.videoWidth,
            h = video.videoHeight;
          if (!w || !h) {
            alert("La c√°mara a√∫n no est√° lista, intenta de nuevo.");
            return;
          }
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(video, 0, 0, w, h);
          const dataUrl = canvas.toDataURL("image/png");
          capturedImages.push(dataUrl);
          renderPreview();
        } finally {
          setTimeout(() => {
            isCapturing = false;
          }, 250); // debounce
        }
      });

      // Detener c√°mara
      btnStopCam.addEventListener("click", () => {
        if (mediaStream) {
          mediaStream.getTracks().forEach((t) => t.stop());
          mediaStream = null;
        }
        video.classList.add("hidden");
        btnCapture.disabled = true;
        btnStopCam.disabled = true;
      });

      // ========= Utilidades =========
      function showLoading(show = true) {
        document
          .getElementById("loadingModal")
          .classList.toggle("hidden", !show);
      }

      function formToJSON(formEl) {
        const fd = new FormData(formEl);
        const data = {};
        for (let [key, value] of fd.entries()) {
          if (key.includes("[]")) {
            const k = key.replace("[]", "");
            if (!data[k]) data[k] = [];
            data[k].push(value);
          } else {
            data[key] = value;
          }
        }
        data.timestamp = new Date().toISOString();
        data.fotos = [...uploadedImages, ...capturedImages]; // base64
        return data;
      }

      async function postJSON(url, payload) {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        return res.ok;
      }

      function resetAll(formEl) {
        formEl.reset();
        document.getElementById("activityContainer").innerHTML = "";
        document.getElementById("incidentContainer").innerHTML = "";
        document.getElementById("equiposContainer").innerHTML = "";
        document.getElementById("materialesContainer").innerHTML = "";
        document.getElementById("calidadContainer").innerHTML = "";
        photoPreview.innerHTML = "";
        activityCount = 0;
        incidentCount = 0;
        equipoCount = 0;
        materialCount = 0;
        calidadCount = 0;
        uploadedImages = [];
        capturedImages = [];
      }

      // ========= Env√≠os =========
      document
        .getElementById("inspectionForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          showLoading(true);
          try {
            const payload = formToJSON(e.target);
            const ok = await postJSON(WEBHOOK_URL, payload);
            if (ok) {
              alert("‚úÖ ¬°Reporte enviado al webhook correctamente!");
              resetAll(e.target);
              // Vuelve a crear una fila por defecto en cada secci√≥n
              addActivity();
              addEquipo();
              addMaterial();
              addCalidad();
            } else {
              alert("‚ùå Error al enviar el reporte al webhook.");
            }
          } catch (err) {
            console.error(err);
            alert("‚ùå Error de conexi√≥n.");
          } finally {
            showLoading(false);
          }
        });

      document.getElementById("btnIA").addEventListener("click", async () => {
        const form = document.getElementById("inspectionForm");
        showLoading(true);
        try {
          const payload = formToJSON(form);
          payload.modo = "analisis_ia";
          const ok = await postJSON(ANALYSIS_WEBHOOK_URL, payload);
          if (ok) {
            alert(
              "ü§ñ‚úÖ An√°lisis por IA enviado. Revisa tu n8n para el resultado."
            );
          } else {
            alert("ü§ñ‚ùå Hubo un problema enviando al webhook de IA.");
          }
        } catch (err) {
          console.error(err);
          alert("ü§ñ‚ùå Error de conexi√≥n.");
        } finally {
          showLoading(false);
        }
      });

      // ========= Estado inicial =========
      window.addEventListener("load", () => {
        addActivity();
        addEquipo();
        addMaterial();
        addCalidad();
      });
    </script>
  </body>
</html>
