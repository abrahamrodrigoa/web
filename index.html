<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Multi Agente IA-ARAT</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --ink:#1f2937; --ink-dim:#374151; --line:#0000001a;
      --brand:#facc15; --brand-2:#fde047;
      --bubble:#ffffff; --bubbleUser:#fff7cc; --chip:#0000000a;
      --accent:#a16207;
      --risk:#ef4444;
      --bg-a:#f2f3f5; --bg-b:#e9ebee;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      color:var(--ink);
      display:flex; flex-direction:column;
      background:
        radial-gradient(900px 400px at 85% 10%, #ffe68055, transparent 60%),
        linear-gradient(135deg, var(--bg-a) 0%, var(--bg-b) 50%, #fff1b3 100%);
      background-attachment: fixed;
      position: relative;
    }
    /* ===== Fixed, behind-the-page background for IA ===== */
    body.theme-IA::before{
      content:"";
      position:fixed;
      inset:0;
      z-index:-1;
      background:
        linear-gradient(rgba(0,0,0,.25), rgba(0,0,0,.25)),
        url('file:///d:/iaarat/fondo-IA.jpg');
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
    }
    /* remove image when not IA */
    body:not(.theme-IA)::before{ content:none; }

    .container{max-width:1104px;margin:0 auto;padding:0 16px}

    /* ===== Header ===== */
    header{position:sticky; top:0; z-index:50; backdrop-filter:saturate(160%) blur(8px);
      background:rgba(255,255,255,.6); border-bottom:1px solid var(--line);}
    .hdr{display:flex;align-items:center;gap:12px;padding:14px 0}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
    /* The logo never changes; source stays constant */
    .brand img#logo{width:36px;height:36px;border-radius:10px;border:1px solid var(--line);object-fit:cover}
    .brand span{font-weight:700;letter-spacing:.2px}

    nav{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    .tab{display:inline-block;padding:8px 12px;border-radius:999px;font-size:14px;
      text-decoration:none;color:var(--ink-dim); border:1px solid var(--line);
      background:rgba(255,255,255,.7); transition:.2s transform,.2s box-shadow,.2s background,.2s color,.2s border-color; white-space:nowrap}
    .tab:hover{color:#111827;border-color:#00000022;background:#ffffff;transform:translateY(-1px);box-shadow:0 8px 24px #00000014}
    .tab.active{background:#fde68a;border-color:#fcd34d;color:#111827;box-shadow:0 8px 22px #f59e0b22}

    .tab.risk:hover{background:#fff1f2;border-color:#fecaca;color:#7f1d1d;box-shadow:0 8px 22px #ef444422}
    .tab.risk.active{background:#fecaca;border-color:#ef4444;color:#7f1d1d;box-shadow:0 8px 22px #ef444433}

    .lang{position:relative}
    .lang-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:999px;
      border:1px solid var(--line); background:#fff; text-decoration:none; color:#111827; cursor:pointer; font-weight:600}

    main{flex:1}
    .title{margin:24px 0 6px;text-align:center;font-size:28px;font-weight:800;display:flex;gap:10px;align-items:center;justify-content:center}
    .ia-box{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:10px;
      background:#fff;border:1px solid var(--line);font-weight:800;letter-spacing:.3px; color:#111827;
      transition:.2s transform,.2s box-shadow,.2s background}
    .ia-box:hover{background:#fff7cc;box-shadow:0 8px 20px #facc1533; transform:translateY(-1px)}

    .subtitle{margin:0 0 16px;text-align:center;color:#4b5563}
    code.inline{background:#0000000d;padding:2px 6px;border-radius:6px}

    .panel{height:70vh; min-height:460px; background:rgba(255,255,255,.7);
      border:1px solid var(--line); border-radius:20px; overflow:hidden; display:flex; flex-direction:column;
      box-shadow:0 1px 2px rgba(0,0,0,.06)}
    .log{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:10px;align-items:flex-end}
    .row.user{justify-content:flex-end}
    .row.assistant{justify-content:flex-start}
    .avatar{width:36px;height:36px;flex:0 0 36px;position:relative}
    .avatar img{position:absolute;inset:0;width:36px;height:36px;border-radius:999px;border:1px solid var(--line);object-fit:cover}

    .bubble{max-width:90%; background:var(--bubble); color:#111827; border:1px solid var(--line);
      border-radius:14px; padding:10px 12px; line-height:1.48; white-space:pre-wrap; box-shadow:0 1px 0 #00000010}
    .row.user .bubble{background:var(--bubbleUser); border-color:#fcd34d88}

    .cap{display:inline-flex;align-items:center;gap:8px; font-size:12px; font-weight:700; letter-spacing:.2px;
      background:var(--chip); color:#111827; border:1px solid var(--line);
      border-radius:999px; padding:2px 8px; margin-bottom:8px}
    .cap .dot{width:6px;height:6px;border-radius:999px;background:#f59e0b;box-shadow:0 0 8px #f59e0b77}
    .cap .edit{margin-left:6px; cursor:pointer; opacity:.7}
    .cap .edit:hover{opacity:1}

    .thinking{display:flex;align-items:center;gap:10px; background:#fffceb;border:1px dashed #fcd34d;color:#854d0e;
      border-radius:14px;padding:8px 12px}
    .ellipsis{display:inline-flex;gap:6px;margin-left:6px}
    .ellipsis i{width:6px;height:6px;border-radius:999px;background:var(--accent); opacity:.25;animation:blink 1.4s infinite}
    .ellipsis i:nth-child(2){animation-delay:.2s} .ellipsis i:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.25;transform:translateY(0)} 40%{opacity:1;transform:translateY(-2px)}}

    .composer{border-top:1px solid var(--line);background:rgba(255,255,255,.7);padding:12px}
    .comp-wrap{display:flex;align-items:center;gap:10px;border:1px solid var(--line);border-radius:999px;
      background:#ffffff;padding:6px 8px; box-shadow:0 1px 1px rgba(0,0,0,.03)}
    .comp-wrap .avatar{width:40px;height:40px;flex:0 0 40px}
    .comp-wrap .avatar img{width:40px;height:40px}
    input[type="text"]{flex:1; border:0; outline:none; background:transparent; font-size:15px; color:#111827}
    input::placeholder{color:#9ca3af}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px; cursor:pointer}
    .icon-btn{width:40px;height:40px;border-radius:999px;border:1px solid #e5e7eb;background:#ffffff}
    .send{width:42px;height:42px;border-radius:999px;border:1px solid #eab30880;
      background:linear-gradient(135deg, var(--brand), var(--brand-2));
      display:inline-flex;align-items:center;justify-content:center; cursor:pointer; transition:.15s transform,.15s filter}
    .send:hover{filter:brightness(1.05)} .send:active{transform:scale(.96)}

    .file-pill{display:inline-flex;align-items:center;gap:8px;background:#fff7cc;border:1px solid #fcd34d;
      color:#111827;border-radius:999px;padding:6px 10px;font-size:12px}
    .file-pill .name{max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .hint{margin-top:6px;font-size:12px;color:#4b5563}

    .whatsapp-wrap{position:fixed;left:18px;bottom:18px;z-index:60}

    @media (max-width:680px){.title{font-size:24px} .panel{height:calc(100dvh - 260px)}}
  </style>
</head>
<body>
  <header>
    <div class="container hdr">
      <a class="brand" href="#">
        <!-- Logo estable desde d:\iaarat\ -->
        <img id="logo" src="file:///d:/iaarat/logo-rodri.png" alt="Logo Rodrigo" />
        <span>Multi Agente IA-ARAT</span>
      </a>

      <nav id="tabs" aria-label="Secciones"></nav>

      <div class="lang">
        <button id="langBtn" class="lang-btn" type="button" title="Cambiar idioma">ES ⇄ EN</button>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <h1 class="title">
        <span class="ia-box" aria-hidden="true">IA</span>
        <span id="page-title-text" data-i18n="tab.specs">Especificaciones Técnicas</span>
      </h1>
      <p class="subtitle">
        <span data-i18n="subtitle.1">Estás en la plataforma única. Canal lógico:</span>
        <code id="botlink-label" class="inline">BOTON_Especificaciones_Técnicas</code>
      </p>

      <section class="panel" aria-label="Chat">
        <div id="log" class="log" role="log" aria-live="polite" aria-relevant="additions"></div>

        <form id="composer" class="composer" autocomplete="off">
          <div class="comp-wrap">
            <div class="avatar">
              <img src="icorobotito.png" alt="robotito_ARAT" />
            </div>

            <button id="fileBtn" type="button" class="btn icon-btn" title="Adjuntar archivo (📎)" data-i18n-attr="title:attach">
              📎
            </button>
            <input id="fileInput" type="file" style="display:none" />

            <input id="input" type="text" placeholder="Escribe tu mensaje…" data-i18n-attr="placeholder:placeholder" />
            <button type="submit" class="send" aria-label="Enviar" data-i18n-attr="aria-label:send">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M3 11l18-8-8 18-2-7-8-3z" stroke="#0b1230" stroke-width="2" fill="none" />
              </svg>
            </button>
          </div>
          <div class="hint">
            <span data-i18n="hint.chan">Canal actual:</span>
            <code id="botlink" class="inline">BOTON_Especificaciones_Técnicas</code> ·
            <span data-i18n="hint.session">Sesión de</span> <strong id="who">…</strong>
          </div>
        </form>
      </section>
    </div>
  </main>

  <div class="whatsapp-wrap">
    <a href="https://wa.me/59178257710?text=Hola,%20te%20saluda%20Rodrigo%20%F0%9F%91%8B.%20%C2%BFEn%20qu%C3%A9%20puedo%20ayudarte%20hoy%3F"
       target="_blank"
       style="background:#25D366;color:#fff;padding:12px 18px;border-radius:10px;
              font-weight:600;text-decoration:none;display:inline-flex;gap:8px;align-items:center;box-shadow:0 10px 20px rgba(0,0,0,.15)">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 32 32" fill="currentColor" aria-hidden="true">
        <path d="M19.11 17.07c-.26-.13-1.53-.75-1.77-.84s-.41-.13-.58.13-.66.84-.81 1.02-.3.19-.56.06a7.3 7.3 0 0 1-2.14-1.32 8 8 0 0 1-1.49-1.84c-.16-.26 0-.4.12-.53s.26-.3.39-.46.17-.26.26-.43.04-.32-.02-.46-.58-1.4-.8-1.92-.43-.45-.58-.46h-.5a.96.96 0 0 0-.69.32 2.9 2.9 0 0 0-.9 2.15 5 5 0 0 0 1.06 2.67 11.4 11.4 0 0 0 4.38 3.93 14 14 0 0 0 1.43.59 3.44 3.44 0 0 0 1.58.1c.48-.08 1.53-.62 1.75-1.22s.22-1.12.16-1.22-.23-.18-.49-.31z"/>
        <path d="M27.1 4.9A13.5 13.5 0 0 0 16 1 13.7 13.7 0 0 0 2.3 14.84 13.3 13.3 0 0 0 4.5 22L3 29l7.2-1.9a13.9 13.9 0 0 0 6.8 1.8h.01A13.7 13.7 0 0 0 31 15.08 13.5 13.5 0 0 0 27.1 4.9zm-11.1 22a11.6 11.6 0 0 1-5.9-1.6l-.42-.25-4.3 1.1 1.1-4.2-.28-.44a11.6 11.6 0 1 1 10.79 5.38z"/>
      </svg>
      <span data-i18n="wa">Contactar por WhatsApp</span>
    </a>
  </div>

  <script>
    /* ================== CONFIG TABS + WEBHOOK ================== */
    const TABS = ["IA","Especificaciones Técnicas","Ensayos de Suelos","Riesgos","Contrato","Contacto"];

    const BASE = "https://uncontracted-pettedly-gannon.ngrok-free.app/webhook/1fab9370-3f57-4806-b8d2-3389d5e95fcb/chat";
    const WEBHOOKS = {
      "Especificaciones Técnicas": BASE,
      "Ensayos de Suelos": BASE,
      "Riesgos": BASE,
      "Contrato": BASE,
      "IA": BASE,
      DEFAULT: BASE,
    };
    const CHANNEL_NOTES = {
      "Especificaciones Técnicas": "Colocar aqui para Especificaciones Técnicas",
      "Ensayos de Suelos": "Colocar aqui Ensayos de Suelos",
      "Riesgos": "Colocar aqui Riesgos",
      "Contrato": "Colocar aqui Contrato",
      "IA": "Colocar aqui para IA",
    };

    /* ================== HELPERS ================== */
    const qs = s => document.querySelector(s);
    function getActiveBot(){
      const u = new URL(window.location.href);
      const raw = (u.searchParams.get("bot") || "").toLowerCase();
      const found = TABS.find(t => t.toLowerCase() === raw);
      return found || "Especificaciones Técnicas";
    }
    function botToLink(name){ return "BOTON_" + name.replace(/\s+/g,"_"); }

    (function renderTabs(){
      const nav = qs("#tabs");
      const active = getActiveBot();
      const current = location.pathname.split('/').pop() || "index.html";

      nav.innerHTML = TABS.map(tab=>{
        if (tab === "Contacto"){
          return `<a class="tab${tab===active?' active':''}" href="contacto rodrigo.html" data-i18n-tab="${tab}">${tab}</a>`;
        }
        const href = `${current}?bot=${encodeURIComponent(tab)}`;
        const extraClass = tab === "Riesgos" ? " risk" : "";
        const cls = "tab" + (tab===active ? " active" : "") + extraClass;
        return `<a class="${cls}" href="${href}" data-i18n-tab="${tab}">${tab}</a>`;
      }).join("");
    })();

    const activeBot = getActiveBot();
    const link = botToLink(activeBot);
    qs("#page-title-text").textContent = activeBot;
    qs("#botlink-label").textContent = link;
    qs("#botlink").textContent = link;

    /* ================== THEMES BY BOT ================== */
    function setThemeForBot(name){
      const body = document.body;
      body.classList.remove("theme-IA");
      // base plomo/amarillo by default
      body.style.background =
        "radial-gradient(900px 400px at 85% 10%, #ffe68055, transparent 60%),"+
        "linear-gradient(135deg, #f2f3f5 0%, #e9ebee 50%, #fff1b3 100%)";

      if (name === "Ensayos de Suelos"){
        body.style.background =
          "radial-gradient(900px 400px at 85% 10%, #bbf7d055, transparent 60%),"+
          "linear-gradient(135deg, #f2f3f5 0%, #e9ebee 50%, #dcfce7 100%)";
      } else if (name === "Riesgos"){
        body.style.background =
          "radial-gradient(900px 400px at 85% 10%, #fecdd355, transparent 60%),"+
          "linear-gradient(135deg, #f2f3f5 0%, #e9ebee 50%, #fee2e2 100%)";
      } else if (name === "Contrato"){
        body.style.background =
          "radial-gradient(900px 400px at 85% 10%, #bfdbfe55, transparent 60%),"+
          "linear-gradient(135deg, #f2f3f5 0%, #e9ebee 50%, #dbeafe 100%)";
      } else if (name === "IA"){
        // Enable behind-the-page background image
        body.classList.add("theme-IA");
      }
    }
    setThemeForBot(activeBot);

    /* ======= NOMBRES PROTEGIDOS (sin lápiz) ======= */
    function isProtectedName(name){
      return /^(rodrigo|rodri)$/i.test((name||"").trim());
    }

    /* ================== USER NAME ================== */
    const NAME_KEY = "arat_user_name";
    let userName = localStorage.getItem(NAME_KEY) || "";
    if (!userName) {
      userName = (prompt("¡Hola! ¿Cómo te llamas?") || "Usuario").trim();
      localStorage.setItem(NAME_KEY, userName);
    }
    const who = qs("#who"); who.textContent = userName;

    function setUserName(newName){
      userName = (newName || "Usuario").trim();
      localStorage.setItem(NAME_KEY, userName);
      who.textContent = userName;

      document.querySelectorAll('.row.user .cap').forEach(cap=>{
        const showEdit = !isProtectedName(userName);
        cap.innerHTML = `<span class="dot"></span> ${userName}${showEdit ? ' <span class="edit" title="Editar">✏️</span>' : ''}`;
        if (showEdit) {
          cap.querySelector('.edit')?.addEventListener('click', ()=>{
            const nv = prompt("Actualizar nombre:", userName || "");
            if (nv) setUserName(nv);
          });
        }
      });
    }

    /* ================== IN-PAGE LANG TOGGLE (ES/EN) ================== */
    const I18N = {
      ES: {
        "tab.specs": "Especificaciones Técnicas",
        "tab.soils": "Ensayos de Suelos",
        "tab.risks": "Riesgos",
        "tab.contract": "Contrato",
        "subtitle.1": "Estás en la plataforma única. Canal lógico:",
        "attach": "Adjuntar archivo (📎)",
        "placeholder": "Escribe tu mensaje…",
        "send": "Enviar",
        "hint.chan": "Canal actual:",
        "hint.session": "Sesión de",
        "wa": "Contactar por WhatsApp",
        "IA": "IA",
        "Especificaciones Técnicas":"Especificaciones Técnicas",
        "Ensayos de Suelos":"Ensayos de Suelos",
        "Riesgos":"Riesgos",
        "Contrato":"Contrato",
        "Contacto":"Contacto"
      },
      EN: {
        "tab.specs": "Technical Specifications",
        "tab.soils": "Soil Tests",
        "tab.risks": "Risks",
        "tab.contract": "Contract",
        "subtitle.1": "You are on the unified platform. Logic channel:",
        "attach": "Attach file (📎)",
        "placeholder": "Type your message…",
        "send": "Send",
        "hint.chan": "Current channel:",
        "hint.session": "Session of",
        "wa": "Contact via WhatsApp",
        "IA": "AI",
        "Especificaciones Técnicas":"Technical Specifications",
        "Ensayos de Suelos":"Soil Tests",
        "Riesgos":"Risks",
        "Contrato":"Contract",
        "Contacto":"Contact"
      }
    };
    const LANG_KEY = "arat_lang";
    let lang = localStorage.getItem(LANG_KEY) || "ES";
    const langBtn = qs("#langBtn");
    langBtn.textContent = "ES ⇄ EN";

    function applyI18n(){
      const dict = I18N[lang] || I18N.ES;
      // Simple elements with data-i18n key
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const k = el.getAttribute("data-i18n");
        if (dict[k]) el.textContent = dict[k];
      });
      // Attributes mapping like placeholder/title/aria-label
      document.querySelectorAll("[data-i18n-attr]").forEach(el=>{
        const pairs = el.getAttribute("data-i18n-attr").split(","); // e.g. "placeholder:placeholder"
        pairs.forEach(p=>{
          const [attr,key] = p.split(":");
          if (I18N[lang][key]) el.setAttribute(attr, I18N[lang][key]);
        });
      });
      // Tabs text
      document.querySelectorAll("[data-i18n-tab]").forEach(a=>{
        const key = a.getAttribute("data-i18n-tab");
        if (I18N[lang][key]) a.textContent = I18N[lang][key];
      });
    }
    applyI18n();

    // Toggle language. We CANNOT force the browser's built-in translator.
    // Instead we translate the visible UI strings in-page.
    langBtn.addEventListener("click", ()=>{
      lang = (lang === "ES") ? "EN" : "ES";
      localStorage.setItem(LANG_KEY, lang);
      applyI18n();
    });

    /* ================== CHAT UI ================== */
    const log = qs("#log");

    function bubble(role, text){
      const row = document.createElement("div");
      row.className = `row ${role}`;
      if (role === "assistant"){
        const av = document.createElement("div");
        av.className = "avatar";
        av.innerHTML = `<img src="icorobotito.png" alt="robotito_ARAT"/>`;
        row.appendChild(av);
      } else {
        const spacer = document.createElement("div");
        spacer.style.width = "36px"; row.appendChild(spacer);
      }

      const b = document.createElement("div"); b.className = "bubble";
      const cap = document.createElement("div"); cap.className = "cap";
      const showEdit = role === "user" && !isProtectedName(userName);
      const capHtml = role === "user"
        ? `<span class="dot"></span> ${userName}${showEdit ? ' <span class="edit" title="Editar">✏️</span>' : ''}`
        : `<span class="dot"></span> robotito_ARAT`;
      cap.innerHTML = capHtml;
      b.appendChild(cap);

      const body = document.createElement("div"); body.textContent = text; b.appendChild(body);
      row.appendChild(b); log.appendChild(row); log.scrollTop = log.scrollHeight;

      if (role === "user" && showEdit) {
        cap.querySelector('.edit')?.addEventListener('click', ()=>{
          const nv = prompt("Actualizar nombre:", userName || "");
          if (nv) setUserName(nv);
        });
      }
      return row;
    }

    function addThinking(){
      const row = document.createElement("div"); row.className = "row assistant";
      const av = document.createElement("div"); av.className = "avatar";
      av.innerHTML = `<img src="icorobotito.png" alt="robotito_ARAT"/>`; row.appendChild(av);
      const box = document.createElement("div"); box.className = "thinking";
      box.innerHTML = `<strong>robotito_ARAT está pensando</strong>
        <span class="ellipsis"><i></i><i></i><i></i></span>`;
      row.appendChild(box); log.appendChild(row); log.scrollTop = log.scrollHeight; return row;
    }

    function bubbleFile(file){
      const row = document.createElement("div");
      row.className = "row user";
      const spacer = document.createElement("div"); spacer.style.width = "36px"; row.appendChild(spacer);

      const b = document.createElement("div"); b.className = "bubble";
      const cap = document.createElement("div"); cap.className = "cap";
      const showEdit = !isProtectedName(userName);
      cap.innerHTML = `<span class="dot"></span> ${userName}${showEdit ? ' <span class="edit" title="Editar">✏️</span>' : ''}`;
      b.appendChild(cap);

      const pill = document.createElement("div");
      pill.className = "file-pill";
      pill.innerHTML = `📄 <span class="name">${file.name}</span> <span class="muted">(${Math.round(file.size/1024)} kB)</span>`;
      b.appendChild(pill);

      row.appendChild(b); log.appendChild(row); log.scrollTop = log.scrollHeight;

      if (showEdit) {
        cap.querySelector('.edit')?.addEventListener('click', ()=>{
          const nv = prompt("Actualizar nombre:", userName || "");
          if (nv) setUserName(nv);
        });
      }
      return row;
    }

    /* ================== SESSION + AGENT ================== */
    const SESSION_KEY = "arat_session_id";
    const sessionId = localStorage.getItem(SESSION_KEY) || crypto.randomUUID();
    localStorage.setItem(SESSION_KEY, sessionId);
    const AGENT_URL = WEBHOOKS[activeBot] || WEBHOOKS.DEFAULT;
    const NOTE = CHANNEL_NOTES[activeBot] || "";

    async function sendToAgent({text, attachments}){
      const payload = {
        action: "sendMessage",
        sessionId,
        chatInput: text || "",
        attachments: attachments || [],
        channel: botToLink(activeBot),
        note: NOTE
      };
      const res = await fetch(AGENT_URL, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const ct = res.headers.get("content-type") || "";
      let body = ct.includes("application/json") ? await res.json() : await res.text();
      if (!res.ok) { const err = typeof body === "string" ? body : JSON.stringify(body); throw new Error(err || `HTTP ${res.status}`); }
      if (typeof body === "string") { const s = body.trim(); if (s.startsWith("{")||s.startsWith("[")) { try{ body = JSON.parse(s);}catch{} } }
      if (typeof body?.output === "string") return body.output;
      if (Array.isArray(body?.messages) && body.messages.length) {
        const first = body.messages.find(m => typeof m?.text === "string") || body.messages[0];
        if (typeof first?.text === "string") return first.text;
      }
      if (typeof body?.message === "string") return body.message;
      if (typeof body?.text === "string")    return body.text;
      if (typeof body?.answer === "string")  return body.answer;
      const gem = body?.response?.generations?.[0]?.text; if (typeof gem === "string") return gem;
      return typeof body === "string" ? body : JSON.stringify(body);
    }

    /* ================== STARTUP ================== */
    // apply theme
    setThemeForBot(activeBot);

    // greeting
    function greet(){
      bubble("assistant", `Hola ${userName}, estás en ${activeBot}. ¿En qué te ayudo?`);
    }
    greet();

    (async function startConversation(){
      const thinking = addThinking();
      try{
        const txt = await sendToAgent({ text: `Me llamo ${userName}. ¿Puedes presentarte y decir cómo me ayudarás en ${activeBot}?` });
        thinking.remove(); if (txt) bubble("assistant", txt);
      } catch (e){ thinking.remove(); bubble("assistant", `Inicio: ${e.message || e}`); }
    })();

    /* ================== COMPOSER: TEXTO ================== */
    qs("#composer").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const input = qs("#input"); const text = (input.value || "").trim(); if(!text) return;

      bubble("user", text);
      detectNameInText(text);
      input.value = "";

      const thinking = addThinking();
      try{
        const reply = await sendToAgent({ text });
        thinking.remove(); bubble("assistant", reply);
      } catch(err){
        thinking.remove(); bubble("assistant", String(err));
      }
    });

    /* Detecta nombre en mensajes */
    function detectNameInText(text){
      const t = text.toLowerCase().trim();
      const rx = /(me llamo|mi nombre es|soy)\s+([a-zA-ZÀ-ÿ'\- ]{2,})$/i;
      const m = t.match(rx);
      if (m && m[2]) {
        const name = m[2].replace(/[.,;:!?]+$/,'').trim();
        if (name) setUserName(name);
      }
    }

    /* ================== COMPOSER: ARCHIVOS ================== */
    const fileBtn  = qs("#fileBtn");
    const fileIn   = qs("#fileInput");
    fileBtn.addEventListener("click", ()=> fileIn.click());

    fileIn.addEventListener("change", async ()=>{
      const f = fileIn.files?.[0]; if(!f) return;
      bubbleFile(f);

      const dataBase64 = await new Promise((res,rej)=>{
        const r = new FileReader();
        r.onload = ()=> res(String(r.result).split(',')[1] || "");
        r.onerror = rej;
        r.readAsDataURL(f);
      });

      const thinking = addThinking();
      try{
        const reply = await sendToAgent({
          text: `(El usuario adjuntó un archivo: ${f.name}, ${f.type || 'sin MIME'}, ${f.size} bytes).`,
          attachments: [{ name:f.name, type:f.type || 'application/octet-stream', size:f.size, dataBase64 }]
        });
        thinking.remove(); bubble("assistant", reply);
      }catch(e){
        thinking.remove(); bubble("assistant", `No se pudo enviar el archivo: ${e.message || e}`);
      }finally{
        fileIn.value = "";
      }
    });

  </script>
</body>
</html>
